<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ì„œìš¸ì‹œ ì „ì²´ ë”°ë¦‰ì´ ì§€ë„</title>
    <style>
      body {
        font-family: sans-serif;
        margin: 0;
        padding: 2rem;
        background-color: #f4f7f6;
      }
      .info-box {
        position: absolute;
        top: 20px;
        left: 20px;
        z-index: 10;
        background: white;
        padding: 10px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        font-family: "Malgun Gothic", sans-serif;
      }
      .loading {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 20;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 20px;
        border-radius: 10px;
        display: none;
        text-align: center;
        font-size: 1.1rem;
      }
      #map {
        width: 100%;
        height: 80vh;
        margin-top: 2rem;
        border-radius: 10px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      }
    </style>
  </head>
  <body>
    <div class="info-box">
      <b>ğŸš² ì„œìš¸ì‹œ ì „ì²´ ë”°ë¦‰ì´ ìŠ¤í…Œì´ì…˜</b><br />
      <span id="status">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span>
    </div>
    <div id="loading" class="loading">
      ì„œìš¸ì‹œ ì „ì²´ ë°ì´í„°(ì•½ 3,000ê°œ)ë¥¼<br />ê°€ì ¸ì˜¤ê³  ìˆìŠµë‹ˆë‹¤...
    </div>
    <div id="map"></div>

    <script
      defer
      type="text/javascript"
      src="//dapi.kakao.com/v2/maps/sdk.js?appkey=3b712df3fcec0d229c24001d23d1d86c&autoload=false&libraries=services,clusterer"
    ></script>

    <script>
      // âš ï¸ ì£¼ì˜: ì„œìš¸ì‹œ API í‚¤ëŠ” ë…¸ì¶œë˜ì§€ ì•Šë„ë¡ ì„œë²„ ì¸¡ì—ì„œ ê´€ë¦¬í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.
      const SEOUL_API_KEY = "4b5661637164656a34375359466168";
      let currentInfoWindow = null;

      /**
       * ë§µ ì´ˆê¸°í™” í•¨ìˆ˜
       * kakao.maps.load()ê°€ ì™„ë£Œëœ í›„ í˜¸ì¶œë˜ì–´ì•¼ í•©ë‹ˆë‹¤.
       */
      function initMap() {
        const mapContainer = document.getElementById("map");
        const defaultCenter = new kakao.maps.LatLng(37.5665, 126.978); // ì„œìš¸ ì‹œì²­
        const mapOption = {
          center: defaultCenter,
          level: 4, // ì§€ë„ë¥¼ ì–´ëŠ ì •ë„ í™•ëŒ€í•´ì„œ ì‹œì‘í• ì§€
        };
        const map = new kakao.maps.Map(mapContainer, mapOption);

        // 1. ë§ˆì»¤ í´ëŸ¬ìŠ¤í„°ëŸ¬ ìƒì„±
        const clusterer = new kakao.maps.MarkerClusterer({
          map: map,
          averageCenter: true,
          minLevel: 5,
        });

        // 2. Geolocation APIë¥¼ ì‚¬ìš©í•˜ì—¬ í˜„ì¬ ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë¡œì§
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            function (position) {
              const lat = position.coords.latitude;
              const lon = position.coords.longitude;
              const locPosition = new kakao.maps.LatLng(lat, lon);

              map.setCenter(locPosition);
              map.setLevel(4); // í˜„ì¬ ìœ„ì¹˜ ì£¼ë³€ì´ ë³´ì´ë„ë¡ í™•ëŒ€

              // í˜„ì¬ ìœ„ì¹˜ ë§ˆì»¤ í‘œì‹œ
              const currentMarker = new kakao.maps.Marker({
                map: map,
                position: locPosition,
                image: new kakao.maps.MarkerImage(
                  "./img/rainbow.png", // âš ï¸ ì´ë¯¸ì§€ íŒŒì¼ ê²½ë¡œê°€ ì˜¬ë°”ë¥¸ì§€ í™•ì¸í•˜ì„¸ìš”.
                  new kakao.maps.Size(50, 50)
                ),
              });

              const currentLocContent = `<div style="padding:5px; font-size:12px;">
                ğŸ“ <b>í˜„ì¬ ìœ„ì¹˜</b>
              </div>`;
              const currentLocInfoWindow = new kakao.maps.InfoWindow({
                content: currentLocContent,
                removable: true,
              });

              // í˜„ì¬ ìœ„ì¹˜ ë§ˆì»¤ í´ë¦­ ì´ë²¤íŠ¸
              kakao.maps.event.addListener(currentMarker, "click", function () {
                if (currentInfoWindow) {
                  currentInfoWindow.close();
                }
                currentLocInfoWindow.open(map, currentMarker);
                currentInfoWindow = currentLocInfoWindow;
              });
            },
            function (error) {
              // ìœ„ì¹˜ ì •ë³´ íšë“ ì‹¤íŒ¨ ì‹œ (ë””í´íŠ¸ ìœ„ì¹˜ ì‚¬ìš©)
              console.error("ìœ„ì¹˜ ì •ë³´ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:", error);
            },
            {
              timeout: 10000,
            }
          );
        }

        // 3. ë”°ë¦‰ì´ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì‹œì‘
        fetchAllBikeData(map, clusterer);
      }

      /**
       * ì„œìš¸ì‹œ APIì—ì„œ ì „ì²´ ë”°ë¦‰ì´ ë°ì´í„°ë¥¼ ë¶„í• í•˜ì—¬ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜ (Promise.all ì‚¬ìš©)
       * @param {kakao.maps.Map} map ì¹´ì¹´ì˜¤ ì§€ë„ ê°ì²´
       * @param {kakao.maps.MarkerClusterer} clusterer ë§ˆì»¤ í´ëŸ¬ìŠ¤í„°ëŸ¬ ê°ì²´
       */
      async function fetchAllBikeData(map, clusterer) {
        document.getElementById("loading").style.display = "block";

        // API í˜¸ì¶œ ë²”ìœ„ (ìµœëŒ€ 4000ê°œê¹Œì§€)
        const ranges = [
          { start: 1, end: 1000 },
          { start: 1001, end: 2000 },
          { start: 2001, end: 3000 },
          { start: 3001, end: 4000 },
        ];

        let allStations = [];

        try {
          const requests = ranges.map((range) =>
            // âš ï¸ GitHub Pagesì—ì„œ HTTP í˜¸ì¶œ ì‹œ Mixed Content ì˜¤ë¥˜ ë°œìƒ ê°€ëŠ¥ì„± ìˆìŒ
            fetch(
              `http://openapi.seoul.go.kr:8088/${SEOUL_API_KEY}/json/bikeList/${range.start}/${range.end}/`
            ).then((res) => res.json())
          );

          const results = await Promise.all(requests);

          results.forEach((data) => {
            if (data.rentBikeStatus && data.rentBikeStatus.row) {
              allStations = allStations.concat(data.rentBikeStatus.row);
            }
          });

          document.getElementById(
            "status"
          ).innerText = `ì´ ${allStations.length}ê°œì†Œ (í´ëŸ¬ìŠ¤í„°ë§ ì ìš©)`;

          drawMarkers(map, clusterer, allStations);
        } catch (error) {
          console.error("ë°ì´í„° ë¡œë“œ ì—ëŸ¬:", error);
          alert("ë”°ë¦‰ì´ ë°ì´í„° ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (API ë˜ëŠ” CORS ë¬¸ì œ)");
        } finally {
          document.getElementById("loading").style.display = "none";
        }
      }

      /**
       * ë°›ì•„ì˜¨ ë°ì´í„°ë¡œ ë§ˆì»¤ë¥¼ ìƒì„±í•˜ê³  í´ëŸ¬ìŠ¤í„°ëŸ¬ì— ì¶”ê°€í•˜ëŠ” í•¨ìˆ˜
       */
      function drawMarkers(map, clusterer, stations) {
        let markers = [];

        stations.forEach((station) => {
          const bikeCount = parseInt(station.parkingBikeTotCnt);
          let makerImagePath = "";
          let imageSize = new kakao.maps.Size(32, 35);

          // ìì „ê±° ëŒ€ìˆ˜ì— ë”°ë¥¸ ë§ˆì»¤ ì´ë¯¸ì§€ ì„ íƒ ë¡œì§
          if (bikeCount === 0) {
            makerImagePath = "./img/red.png"; // ì¬ê³  ì—†ìŒ (ë¹¨ê°•)
          } else if (bikeCount >= 1 && bikeCount <= 4) {
            makerImagePath = "./img/yellow.png"; // ì¬ê³  ë¶€ì¡± (ì£¼í™©/ë…¸ë‘)
          } else {
            makerImagePath = "./img/green.png"; // ì¬ê³  ì¶©ë¶„ (ì´ˆë¡)
          }

          const markerImage = new kakao.maps.MarkerImage(
            makerImagePath,
            imageSize
          );

          const marker = new kakao.maps.Marker({
            position: new kakao.maps.LatLng(
              station.stationLatitude,
              station.stationLongitude
            ),
            title: station.stationName,
            image: markerImage,
          });

          // ì¸í¬ìœˆë„ìš° ë‚´ìš© ì„¤ì •
          const countColor =
            bikeCount === 0 ? "red" : bikeCount <= 4 ? "orange" : "green";
          const infowindow = new kakao.maps.InfoWindow({
            content: `<div style="padding:5px; font-size:12px;">
                ${station.stationName}<br>
                ğŸš² <span style="color:${countColor}; font-weight: bold;">${bikeCount}</span>ëŒ€
            </div>`,
            removable: true,
          });

          // ë§ˆì»¤ í´ë¦­ ì‹œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
          kakao.maps.event.addListener(marker, "click", function () {
            if (currentInfoWindow) {
              currentInfoWindow.close(); // ì´ì „ì— ì—´ë¦° ì •ë³´ì°½ ë‹«ê¸°
            }
            infowindow.open(map, marker);
            currentInfoWindow = infowindow; // í˜„ì¬ ì—´ë¦° ì •ë³´ì°½ ì—…ë°ì´íŠ¸
          });

          markers.push(marker);
        });

        clusterer.addMarkers(markers);
      }

      // ************************************************************
      // 2. ì¹´ì¹´ì˜¤ë§µ SDK ë¡œë“œ í›„ initMap í˜¸ì¶œ (ì˜¤ë¥˜ í•´ê²° í•µì‹¬)
      // ************************************************************
      window.onload = function () {
        // window.onload: HTML ë¬¸ì„œ ë¡œë”©ì´ ì™„ë£Œëœ ì‹œì 
        // kakao.maps.load(): ì¹´ì¹´ì˜¤ë§µ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë”©ì´ ì™„ë£Œëœ ì‹œì  (autoload=false ë•Œë¬¸)
        kakao.maps.load(function () {
          initMap();
        });
      };
    </script>
  </body>
</html>
