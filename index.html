<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ì„œìš¸ì‹œ ì „ì²´ ë”°ë¦‰ì´ ì§€ë„ (í´ëŸ¬ìŠ¤í„°ëŸ¬)</title>
    <script
      defer
      type="text/javascript"
      src="//dapi.kakao.com/v2/maps/sdk.js?appkey=3b712df3fcec0d229c24001d23d1d86c&autoload=false&libraries=services,clusterer"
    ></script>
    <style>
      body {
        font-family: sans-serif;
        margin: 0;
        padding: 2rem;
      }
      .info-box {
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 10;
        background: white;
        padding: 10px 20px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        font-family: sans-serif;
      }
      .loading {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 20;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 20px;
        border-radius: 10px;
        display: none;
        text-align: center;
      }
      #map {
        width: 100%;
        height: 80vh;
        margin-top: 2rem;
        border: 1px solid #ccc;
      }
    </style>
  </head>
  <body>
    <div class="info-box">
      <b>ğŸš² ì„œìš¸ì‹œ ì „ì²´ ë”°ë¦‰ì´</b><br />
      <span id="status">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span>
    </div>
    <div id="loading" class="loading">
      ì„œìš¸ì‹œ ì „ì²´ ë°ì´í„°(ì•½ 3,000ê°œ)ë¥¼<br />ê°€ì ¸ì˜¤ê³  ìˆìŠµë‹ˆë‹¤...
    </div>
    <div id="map"></div>

    <script>
      const SEOUL_API_KEY = "516767576664656a3934487857534e"; //í‚¤ì£¼ì†ŒëŠ” ì•Œì•„ì„œ ë³€ê²½í•˜ì„¸ìš” ì§€ê¸ˆì€ github ìš©ìœ¼ë¡œ ë„£ì–´ë†¨ì–´ìš”!
      let currentInfoWindow = null;

      function initMap() {
        kakao.maps.load(function () {
          const mapContainer = document.getElementById("map");
          const defaultCenter = new kakao.maps.LatLng(37.4999802, 127.035465);
          const mapOption = {
            center: defaultCenter,
            level: 1,
          };
          const map = new kakao.maps.Map(mapContainer, mapOption);

          // 1. ë§ˆì»¤ í´ëŸ¬ìŠ¤í„°ëŸ¬ ìƒì„± (ë§ˆì»¤ë“¤ì„ ê´€ë¦¬í•  ë°”êµ¬ë‹ˆ)
          const clusterer = new kakao.maps.MarkerClusterer({
            map: map, // ë§ˆì»¤ë“¤ì„ í‘œì‹œí•  ì§€ë„ ê°ì²´
            averageCenter: true, // í´ëŸ¬ìŠ¤í„°ëŸ¬ ì¤‘ì‹¬ì„ í¬í•¨ëœ ë§ˆì»¤ë“¤ì˜ í‰ê·  ìœ„ì¹˜ë¡œ ì„¤ì •
            minLevel: 5, // ì§€ë„ê°€ ì´ ë ˆë²¨ë³´ë‹¤ í™•ëŒ€ë˜ë©´ í´ëŸ¬ìŠ¤í„°ê°€ í’€ë¦¬ê³  ë§ˆì»¤ê°€ ë³´ì„
          });

          // â­ï¸ 2. Geolocation APIë¥¼ ì‚¬ìš©í•˜ì—¬ í˜„ì¬ ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë¡œì§ ì¶”ê°€
          if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
              function (position) {
                // ìœ„ì¹˜ ì •ë³´ íšë“ ì„±ê³µ ì‹œ
                const lat = position.coords.latitude; // ìœ„ë„
                const lon = position.coords.longitude; // ê²½ë„

                const locPosition = new kakao.maps.LatLng(lat, lon);

                // ì§€ë„ ì¤‘ì‹¬ì„ í˜„ì¬ ìœ„ì¹˜ë¡œ ì´ë™ì‹œí‚¤ê³  í™•ëŒ€ ë ˆë²¨ ì¡°ì •
                map.setCenter(locPosition);
                map.setLevel(4); // í˜„ì¬ ìœ„ì¹˜ ì£¼ë³€ì´ ë³´ì´ë„ë¡ í™•ëŒ€

                // í˜„ì¬ ìœ„ì¹˜ë¥¼ ë‚˜íƒ€ë‚´ëŠ” ë§ˆì»¤ í‘œì‹œ (ì„ íƒ ì‚¬í•­)
                const currentMarker = new kakao.maps.Marker({
                  map: map,
                  position: locPosition,
                  image: new kakao.maps.MarkerImage(
                    "./img/rainbow.png",
                    new kakao.maps.Size(50, 50)
                  ),
                });

                // â­ï¸ í˜„ì¬ ìœ„ì¹˜ ë§ˆì»¤ì— í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ (ìƒˆë¡œ ì¶”ê°€ë˜ëŠ” ë¶€ë¶„)
                const currentLocContent = `<div style="padding:5px; font-size:12px;">
                ğŸ“ <b>í˜„ì¬ ìœ„ì¹˜</b><br>
                ìœ„ë„: ${lat.toFixed(5)}<br>
                ê²½ë„: ${lon.toFixed(5)}
            </div>`;

                const currentLocInfoWindow = new kakao.maps.InfoWindow({
                  content: currentLocContent,
                  removable: true, // ë‹«ê¸° ë²„íŠ¼
                });

                kakao.maps.event.addListener(
                  currentMarker,
                  "click",
                  function () {
                    // ë‹¤ë¥¸ ë§ˆì»¤ ì •ë³´ì°½ì´ ì—´ë ¤ìˆë‹¤ë©´ ë‹«ê¸° (ì „ì—­ currentInfoWindow í™œìš©)
                    if (currentInfoWindow) {
                      currentInfoWindow.close();
                    }

                    // í˜„ì¬ ìœ„ì¹˜ ì •ë³´ì°½ ì—´ê¸°
                    currentLocInfoWindow.open(map, currentMarker);

                    // ì „ì—­ ë³€ìˆ˜ ì—…ë°ì´íŠ¸ (ë”°ë¦‰ì´ ë§ˆì»¤ í´ë¦­ ì‹œ ì´ê²ƒì„ ë‹«ê²Œ í•¨)
                    currentInfoWindow = currentLocInfoWindow;
                  }
                );
              },
              function (error) {
                // ìœ„ì¹˜ ì •ë³´ íšë“ ì‹¤íŒ¨ ì‹œ (ì—ëŸ¬ ì²˜ë¦¬)
                console.error("ìœ„ì¹˜ ì •ë³´ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:", error);
                alert(
                  "ì‚¬ìš©ì ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ì–´ ì„œìš¸ ì‹œì²­ì„ ì¤‘ì‹¬ìœ¼ë¡œ í‘œì‹œí•©ë‹ˆë‹¤."
                );
              },
              {
                // ì˜µì…˜: ìµœëŒ€ ëŒ€ê¸° ì‹œê°„ 10ì´ˆ
                timeout: 10000,
              }
            );
          } else {
            // Geolocationì„ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì¼ ë•Œ
            alert("ì´ ë¸Œë¼ìš°ì €ëŠ” ìœ„ì¹˜ ì •ë³´ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
          }
          // ë°ì´í„° ê°€ì ¸ì˜¤ê¸° í•¨ìˆ˜ì— mapê³¼ clustererë¥¼ ê°™ì´ ë„˜ê¹€
          fetchAllBikeData(map, clusterer);
        });
      }

      async function fetchAllBikeData(map, clusterer) {
        document.getElementById("loading").style.display = "block";

        // ë°ì´í„° ë²”ìœ„ (3000ê°œê¹Œì§€)
        const ranges = [
          { start: 1, end: 1000 },
          { start: 1001, end: 2000 },
          { start: 2001, end: 3000 },
          { start: 3001, end: 4000 },
        ];

        let allStations = [];

        try {
          const requests = ranges.map((range) =>
            fetch(
              `http://openapi.seoul.go.kr:8088/${SEOUL_API_KEY}/json/bikeList/${range.start}/${range.end}/`
            ).then((res) => res.json())
          );

          const results = await Promise.all(requests);

          results.forEach((data) => {
            if (data.rentBikeStatus && data.rentBikeStatus.row) {
              allStations = allStations.concat(data.rentBikeStatus.row);
            }
          });

          document.getElementById(
            "status"
          ).innerText = `ì´ ${allStations.length}ê°œì†Œ (í´ëŸ¬ìŠ¤í„°ë§ ì ìš©)`;

          // ë§ˆì»¤ ê·¸ë¦¬ê¸° í•¨ìˆ˜ í˜¸ì¶œ
          drawMarkers(map, clusterer, allStations);
        } catch (error) {
          console.error("ì—ëŸ¬:", error);
          alert("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨");
        } finally {
          document.getElementById("loading").style.display = "none";
        }
      }

      function drawMarkers(map, clusterer, stations) {
        let markers = [];

        stations.forEach((station) => {
          // â­ï¸ 1. ì£¼ì°¨ëœ ìì „ê±° ëŒ€ìˆ˜ë¥¼ ìˆ«ìë¡œ ë³€í™˜ (API ë°ì´í„°ëŠ” ë¬¸ìì—´ í˜•íƒœ)
          const bikeCount = parseInt(station.parkingBikeTotCnt);
          let makerImagePath = "";
          let imageSize = new kakao.maps.Size(32, 35);

          // â­ï¸ 2. ìì „ê±° ëŒ€ìˆ˜ì— ë”°ë¥¸ ì¡°ê±´ë¬¸ êµ¬í˜„
          if (bikeCount === 0) {
            // ğŸŸ¥ ì¬ê³  ì—†ìŒ: ë¹¨ê°„ìƒ‰
            makerImagePath = "./img/red.png";
          } else if (bikeCount >= 1 && bikeCount <= 4) {
            // ğŸŸ¨ ì¬ê³  ë¶€ì¡±: ì£¼í™©ìƒ‰ (ë…¸ë€ìƒ‰ì— ê°€ê¹Œìš´ ì´ë¯¸ì§€ ì‚¬ìš©)
            makerImagePath = "./img/yellow.png";
          } else {
            // ğŸŸ© ì¬ê³  ì¶©ë¶„: ì´ˆë¡ìƒ‰
            makerImagePath = "./img/green.png";
          }

          const markerImage = new kakao.maps.MarkerImage(
            makerImagePath,
            imageSize
          );

          // ë§ˆì»¤ ìƒì„± ì‹œ `image` ì†ì„± ì§€ì •
          const marker = new kakao.maps.Marker({
            position: new kakao.maps.LatLng(
              station.stationLatitude,
              station.stationLongitude
            ),
            title: station.stationName,
            image: markerImage, // â­ï¸ ìƒì„±í•œ ì´ë¯¸ì§€ ì ìš©
          });

          // ì¸í¬ìœˆë„ìš° ë‚´ìš©ì€ ë™ì¼ (ìƒ‰ìƒë„ ìì „ê±° ìˆ˜ì— ë”°ë¼ ë‹¤ë¥´ê²Œ í‘œì‹œë©ë‹ˆë‹¤)
          const countColor =
            bikeCount === 0 ? "red" : bikeCount <= 4 ? "orange" : "green";
          const infowindow = new kakao.maps.InfoWindow({
            content: `<div style="padding:5px; font-size:12px;">${station.stationName}<br>ğŸš² <span style="color:${countColor}; font-weight: bold;">${bikeCount}</span>ëŒ€</div>`,
            removable: true,
          });

          kakao.maps.event.addListener(marker, "click", function () {
            if (currentInfoWindow) {
              currentInfoWindow.close();
            }

            infowindow.open(map, marker);
            currentInfoWindow = infowindow;
          });

          markers.push(marker);
        });

        clusterer.addMarkers(markers);
      }

      window.onload = function () {
        kakao.maps.load(function () {
          initMap();
        });
      };
    </script>
  </body>
</html>

