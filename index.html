<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ì„œìš¸ì‹œ ì „ì²´ ë”°ë¦‰ì´ ì§€ë„ (í´ëŸ¬ìŠ¤í„°ëŸ¬)</title>
    <script
      defer
      type="text/javascript"
      src="//dapi.kakao.com/v2/maps/sdk.js?appkey=3b712df3fcec0d229c24001d23d1d86c&autoload=false&libraries=services,clusterer"
    ></script>
    <style>
      body {
        font-family: sans-serif;
        margin: 0;
        padding: 2rem;
      }
      .info-box {
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 10;
        background: white;
        padding: 10px 20px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        font-family: sans-serif;
      }
      .loading {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 20;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 20px;
        border-radius: 10px;
        display: none;
        text-align: center;
      }
      #map {
        width: 100%;
        height: 80vh;
        margin-top: 2rem;
        border: 1px solid #ccc;
      }
      #loadDataBtn {
        background: linear-gradient(45deg, #00c6ff, #0072ff);
        border: none;
        color: white;
        padding: 8px 16px;
        font-size: 14px;
        font-weight: bold;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        margin-top: 1rem;
      }

      #loadDataBtn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 10px rgba(0, 0, 0, 0.3);
        background: linear-gradient(45deg, #0072ff, #00c6ff);
      }

      #loadDataBtn:active {
        transform: translateY(0);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
      }
    </style>
  </head>
  <body>
    <div class="info-box">
      <b>ğŸš² ì„œìš¸ì‹œ ì „ì²´ ë”°ë¦‰ì´</b><br />
      <button id="loadDataBtn">ì‹¤ì‹œê°„ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°</button>
      <span id="status"></span>
    </div>
    <div id="loading" class="loading">
      ì„œìš¸ì‹œ ì „ì²´ ë°ì´í„°(ì•½ 3,000ê°œ)ë¥¼<br />ê°€ì ¸ì˜¤ê³  ìˆìŠµë‹ˆë‹¤...
    </div>
    <div id="map"></div>

    <script>
      let map, clusterer;
      const SEOUL_API_KEY = "4b5661637164656a34375359466168";
      let currentInfoWindow = null;

      function initMap() {
        kakao.maps.load(function () {
          const mapContainer = document.getElementById("map");
          const defaultCenter = new kakao.maps.LatLng(37.4999802, 127.035465);
          const mapOption = { center: defaultCenter, level: 1 };

          map = new kakao.maps.Map(mapContainer, mapOption); // ì „ì—­ mapì— í• ë‹¹
          clusterer = new kakao.maps.MarkerClusterer({
            map: map,
            averageCenter: true,
            minLevel: 5,
          }); // ì „ì—­ clustererì— í• ë‹¹

          // í˜„ì¬ ìœ„ì¹˜ í‘œì‹œ ì½”ë“œ ê·¸ëŒ€ë¡œ ìœ ì§€...
          if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
              function (position) {
                const locPosition = new kakao.maps.LatLng(
                  position.coords.latitude,
                  position.coords.longitude
                );
                map.setCenter(locPosition);
                map.setLevel(4);

                const currentMarker = new kakao.maps.Marker({
                  map: map,
                  position: locPosition,
                  image: new kakao.maps.MarkerImage(
                    "./img/rainbow.png",
                    new kakao.maps.Size(50, 50)
                  ),
                });

                const currentLocInfoWindow = new kakao.maps.InfoWindow({
                  content: `<div style="padding:5px; font-size:12px;">
              ğŸ“ <b>í˜„ì¬ ìœ„ì¹˜</b><br>
              ìœ„ë„: ${position.coords.latitude.toFixed(5)}<br>
              ê²½ë„: ${position.coords.longitude.toFixed(5)}
            </div>`,
                  removable: true,
                });

                kakao.maps.event.addListener(
                  currentMarker,
                  "click",
                  function () {
                    if (currentInfoWindow) currentInfoWindow.close();
                    currentLocInfoWindow.open(map, currentMarker);
                    currentInfoWindow = currentLocInfoWindow;
                  }
                );
              },
              function (error) {
                console.error("ìœ„ì¹˜ ì •ë³´ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:", error);
              },
              { timeout: 10000 }
            );
          }
        });
      }
      // ë²„íŠ¼ í´ë¦­ ì‹œ API í˜¸ì¶œ
      document.getElementById("loadDataBtn").addEventListener("click", () => {
        if (!map || !clusterer) {
          alert(
            "ì§€ë„ ì´ˆê¸°í™”ê°€ ì•„ì§ ì™„ë£Œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”."
          );
          return;
        }
        fetchAllBikeData(map, clusterer);
      });

      async function fetchAllBikeData(map, clusterer) {
        document.getElementById("loading").style.display = "block";

        // ë°ì´í„° ë²”ìœ„ (3000ê°œê¹Œì§€)
        const ranges = [
          { start: 1, end: 1000 },
          { start: 1001, end: 2000 },
          { start: 2001, end: 3000 },
          { start: 3001, end: 4000 },
        ];

        let allStations = [];

        try {
          const requests = ranges.map((range) =>
            fetch(
              `http://openapi.seoul.go.kr:8088/${SEOUL_API_KEY}/json/bikeList/${range.start}/${range.end}/`
            ).then((res) => res.json())
          );

          const results = await Promise.all(requests);

          results.forEach((data) => {
            if (data.rentBikeStatus && data.rentBikeStatus.row) {
              allStations = allStations.concat(data.rentBikeStatus.row);
            }
          });

          document.getElementById(
            "status"
          ).innerText = `ì´ ${allStations.length}ê°œì†Œ (í´ëŸ¬ìŠ¤í„°ë§ ì ìš©)`;

          // ë§ˆì»¤ ê·¸ë¦¬ê¸° í•¨ìˆ˜ í˜¸ì¶œ
          drawMarkers(map, clusterer, allStations);
        } catch (error) {
          console.error("ì—ëŸ¬:", error);
          alert("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨");
        } finally {
          document.getElementById("loading").style.display = "none";
        }
      }

      function drawMarkers(map, clusterer, stations) {
        let markers = [];

        stations.forEach((station) => {
          // â­ï¸ 1. ì£¼ì°¨ëœ ìì „ê±° ëŒ€ìˆ˜ë¥¼ ìˆ«ìë¡œ ë³€í™˜ (API ë°ì´í„°ëŠ” ë¬¸ìì—´ í˜•íƒœ)
          const bikeCount = parseInt(station.parkingBikeTotCnt);
          let makerImagePath = "";
          let imageSize = new kakao.maps.Size(32, 35);

          // â­ï¸ 2. ìì „ê±° ëŒ€ìˆ˜ì— ë”°ë¥¸ ì¡°ê±´ë¬¸ êµ¬í˜„
          if (bikeCount === 0) {
            // ğŸŸ¥ ì¬ê³  ì—†ìŒ: ë¹¨ê°„ìƒ‰
            makerImagePath = "./img/red.png";
          } else if (bikeCount >= 1 && bikeCount <= 4) {
            // ğŸŸ¨ ì¬ê³  ë¶€ì¡±: ì£¼í™©ìƒ‰ (ë…¸ë€ìƒ‰ì— ê°€ê¹Œìš´ ì´ë¯¸ì§€ ì‚¬ìš©)
            makerImagePath = "./img/yellow.png";
          } else {
            // ğŸŸ© ì¬ê³  ì¶©ë¶„: ì´ˆë¡ìƒ‰
            makerImagePath = "./img/green.png";
          }

          const markerImage = new kakao.maps.MarkerImage(
            makerImagePath,
            imageSize
          );

          // ë§ˆì»¤ ìƒì„± ì‹œ `image` ì†ì„± ì§€ì •
          const marker = new kakao.maps.Marker({
            position: new kakao.maps.LatLng(
              station.stationLatitude,
              station.stationLongitude
            ),
            title: station.stationName,
            image: markerImage, // â­ï¸ ìƒì„±í•œ ì´ë¯¸ì§€ ì ìš©
          });

          // ì¸í¬ìœˆë„ìš° ë‚´ìš©ì€ ë™ì¼ (ìƒ‰ìƒë„ ìì „ê±° ìˆ˜ì— ë”°ë¼ ë‹¤ë¥´ê²Œ í‘œì‹œë©ë‹ˆë‹¤)
          const countColor =
            bikeCount === 0 ? "red" : bikeCount <= 4 ? "orange" : "green";
          const infowindow = new kakao.maps.InfoWindow({
            content: `<div style="padding:5px; font-size:12px;">${station.stationName}<br>ğŸš² <span style="color:${countColor}; font-weight: bold;">${bikeCount}</span>ëŒ€</div>`,
            removable: true,
          });

          kakao.maps.event.addListener(marker, "click", function () {
            if (currentInfoWindow) {
              currentInfoWindow.close();
            }

            infowindow.open(map, marker);
            currentInfoWindow = infowindow;
          });

          markers.push(marker);
        });

        clusterer.addMarkers(markers);
      }

      window.onload = function () {
        kakao.maps.load(function () {
          initMap();
        });
      };
    </script>
  </body>
</html>
